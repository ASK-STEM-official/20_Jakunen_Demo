# アプリケーション仕様書
## プロジェクト名
さぬきオリーブ受注管理システム SO-OMS(ソームス)

## システム概要
今まで行っていたECサイトからのCSVデータ取得を自動で行い、そのデータをもとに発注データの管理、在庫の管理を円滑にすることが目的。

## 機能仕様
### 管理者ログイン機能
- 登録された管理者アカウントにログインする
- ユーザーIDとパスワードを用いて認証
- ログイン成功時のみダッシュボード画面に遷移
- 失敗時はエラーメッセージを表示

### 商品マスタ表示機能
- 登録されている商品リストを表示する。
- 商品ID,商品名,カテゴリ,商品説明,単価,在庫数,出品中フラグが確認可能
- 商品名,商品ID,カテゴリ,出品中かどうかで検索・絞り込みが可能
- 詳細ボタンを押下で商品詳細に遷移
- 新規登録ボタン押下で新規登録画面に遷移

### 商品マスタ登録機能
- 商品の新規登録が可能
- 商品情報(商品名,カテゴリ,商品説明,単価,在庫数,アラートしきい値,出品中フラグ)を登録し、DBに保存する機能
- 入力値のバリデーション

### 商品詳細表示機能
- 商品情報の編集が可能
- 商品情報(商品名,カテゴリ,商品説明,単価,在庫数,アラートしきい値,出品中フラグ)を更新しDBに保存する機能

### CSVインポート機能
- ECサイトAPIから受注データ(CSV)を取得、DBに保存
- 手動取得・自動定期取得(10分毎)

### 受注一覧表示機能
- 受注データ(予約ID,顧客名,商品名,数量,予約日,ステータス)を一覧表示
- 予約ID,顧客名,商品名で検索可能
- カテゴリ,予約日,ステータスで絞り込み可能
- 更新ボタン押下でCSVインポート機能を利用可能
- 最終CSV取込日時を表示

### 受注詳細表示機能
- 受注データの詳細表示(予約ID,顧客名,配送先住所,支払い方法,ステータス,ステータス更新日時,受注日,インポート時)
- 受注明細(項目数,商品名,単価,数量,税率,小計)を表示
- 注文の合計金額を表示
- 受注データ(配送先住所,配送先郵便番号,支払い方法,ステータス)の編集が可能
- 更新ボタンを押下でDBに変更データを保存

### 受注ステータス管理機能
- 受注詳細画面から受注ステータス(新規予約,受注確定,発送済み,キャンセル)を更新できる
- ステータスを新規予約から受注確定に更新したタイミングで、該当商品の在庫数を減算する
- 新規予約から発送済に変更した場合、受注確定に変更後発送済みに変更
- 受注確定からキャンセルに変更した場合、該当商品の在庫数を増加する
- 発送済みからキャンセルに変更した場合、在庫数は変更せずステータスの変更のみ
- ステータス変更操作は履歴として記録される（変更日時、変更前後ステータス、操作管理者ID）
- 在庫数が不足している場合、受注確定または発送済への変更を制限する（エラーを表示）

### 顧客情報一覧機能
- 顧客情報(顧客ID,顧客名,住所,電話番号,注文数)を一覧表示
- 顧客ID,顧客名,住所,電話番号で絞り込み・検索
- 詳細ボタン押下で顧客詳細画面に遷移

### 顧客情報詳細表示機能
- 顧客情報(顧客ID,顧客名,住所,電話番号,注文数,登録日)を表示
- 顧客の注文履歴(予約ID,商品コード,商品名,数量,予約日)
- 顧客名,住所,電話番号を変更可能
- 更新ボタン押下で変更データをDBに保存

### 顧客情報登録機能
- 新規顧客情報の登録が可能
- 顧客情報(顧客名,住所,電話番号)を入力しDBに保存
- 入力値のバリデーション

### 簡易集計・分析機能
- 指定期間内の受注金額合計を折れ線グラフ表示
- 年次/月次/日次で表示切り替え
- 期間中の受注金額合計表示

### 在庫アラート機能
- 商品ごとの在庫しきい値を下回った際にダッシュボードでアラート表示
- アラート履歴(対象商品ID,アラート発生日時,対応済みフラグ)の記録・一覧表示
- 対応済みフラグを変更可能
- 対応済みのフラグはアラート一覧から非表示

## 画面仕様
### ログイン画面
- システム名/ロゴ
- ユーザー名,パスワードの入力欄
- ログインボタン(押下でログイン処理)
- 失敗時はダイアログを表示

### ダッシュボード画面
- 商品一覧,受注一覧,分析メニュー,ログアウトボタン
- ログアウトボタン押下でログアウト処理、ログイン画面に遷移
- 商品一覧,受注一覧,分析メニューボタン押下でそれぞれの画面を表示

### 商品一覧画面
- 商品リスト,検索欄,絞り込み,検索ボタン,詳細ボタン,新規登録ボタン
- 商品リストは商品ID,商品名,カテゴリ,説明,単価,在庫,出品中フラグ,詳細ボタンの順でリスト表示
- 説明は20文字以降は"..."で省略
- リストの詳細ボタン押下で該当商品の商品詳細画面を表示
- 商品名・商品ID(入力フォーム),カテゴリ(コンボボックス),出品中表示のみ(チェックボックス)
- 検索ボタン押下で検索実行
- 検索結果の件数を表示

### 商品詳細画面
- 商品ID,商品名,カテゴリ,商品説明,単価,在庫数,出品中,在庫アラートしきい値,保存ボタン,閉じるボタン
- 商品IDは編集不可
- カテゴリ,出品中はコンボボックスで選択
- 閉じるボタン押下で閉じる
- 保存ボタン押下で変更データを保存

### 商品登録画面
- 商品ID,商品名,カテゴリ,説明,単価,在庫数,アラートしきい値,出品中フラグを表示
- 商品IDは変更不可(自動連番)
- 出品中フラグはデフォルト値出品中
- 入力値のバリデーション
- 登録ボタン押下でDBに保存
- キャンセルボタンで画面を閉じる

### 受注一覧画面
- 受注リスト（予約ID、顧客名、商品名、数量、予約日、ステータス）,詳細ボタンをDataGridView等で表示
- 検索欄（予約ID、顧客名、商品名）、絞り込み（カテゴリ、予約日、ステータス）
- 検索ボタンでリスト更新
- 詳細ボタン押下で受注詳細画面を表示
- 新規登録ボタン押下で受注登録画面を表示
- CSVインポートの最終取込日時を表示
- 更新ボタンでCSVインポート処理を実行

### 受注詳細画面
- 受注情報（予約ID、顧客名、顧客ID、電話番号、配送先住所、支払い方法、ステータス、ステータス更新日時、受注日、インポート日時）を表示・編集
- 予約ID、顧客名、ステータス更新日時、受注日、インポート日時は編集不可
- 受注明細（項目数、商品名、単価、数量、税率、小計）をリスト表示
- 合計金額を表示
- ステータス変更時は在庫数の自動調整
- 更新ボタンでDBに保存
- 閉じるボタンで画面を閉じる

### 受注登録画面
- 受注情報（顧客ID、配送先住所、支払い方法、ステータス）を入力
- 登録ボタンでDBに新規登録
- 登録時に受注日を設定
- 入力値のバリデーション
- キャンセルボタンで画面を閉じる

### 分析メニュー画面
- 売上グラフ・顧客一覧ボタンを配置
- 各ボタン押下で該当画面を表示

### 顧客一覧画面
- 顧客リスト（顧客ID、顧客名、住所、電話番号、注文数）、詳細ボタンをDataGridView等で表示
- 検索欄（顧客ID、顧客名、住所、電話番号）
- 検索ボタン押下でリスト更新
- 詳細ボタン押下で顧客詳細画面を表示
- 新規登録ボタン押下で顧客登録画面を表示
- 戻るボタンで画面を閉じる

### 顧客詳細画面
- 顧客情報（顧客ID、顧客名、住所、電話番号、注文数）を表示・編集
- 顧客ID、注文数は変更不可
- 顧客の注文履歴（予約ID、商品コード、商品名、数量、予約日）をリスト表示
- 更新ボタンでDBに保存
- 閉じるボタンで画面を閉じる

### 顧客登録画面
- 顧客情報（顧客名、住所、電話番号）を入力するフォーム
- 登録時に登録日を設定
- 登録ボタンでDBに新規登録
- 入力値のバリデーション
- キャンセルボタンで画面を閉じる

### 受注金額グラフ画面
- 指定期間内の受注金額合計を折れ線グラフで表示
- 年次／月次／日次の切り替えで表示を更新
- 期間中の受注金額合計を数値で表示
- 戻るボタン押下で閉じる

## 品質仕様
### 保守性
- コードは機能単位でクラス・ファイルを分割し、SOLID原則に従って設計する。
- 設定値（DB接続文字列、APIエンドポイント等）はApp.configで一元管理し、環境ごとに切り替え可能とする。
- 画面・ロジック・データアクセス層を分離し、UI変更やDB変更時の影響範囲を最小化する。

### 拡張性
- 新規画面・機能追加時は既存コードの修正を最小限に抑えられるよう、インターフェースや抽象クラスを活用する。
- 商品・顧客・受注などのマスタデータ項目追加時も、DB・画面・ロジックの修正箇所が明確になるよう設計する。
- 外部API連携（例：他ECサイト追加）や帳票出力機能の追加を想定し、拡張ポイントを設ける。
- 多言語対応は現時点で不要。画面・帳票等は日本語のみ対応。

## セキュリティ仕様

### アカウント・認証
- 管理者アカウントは事前登録のみ。アプリケーション上での追加・編集・削除機能は実装しない。必要な場合はDB直接編集で対応。
- パスワードはPBKDF2またはbcryptでハッシュ化し、ソルトを付与して保存。
- パスワード入力欄は「*」でマスク表示

### データ保護
- 管理者パスワードはハッシュ化したもののみ保存し、平文では保持しない。
- 顧客情報（氏名、住所、電話番号）は受注情報と分離したテーブルで管理し、個人情報漏洩リスクを低減。
- 商品・受注・顧客の削除は論理削除または非表示とし、履歴・整合性を保持。
- CSV等の生データは一時保存せず、DB登録後は速やかに破棄。

### ログ管理・責任追跡性
- 受注ステータス変更の操作履歴をDBに記録。

## 例外処理仕様

### 入力エラー
- 必須項目未入力、形式不正（例：電話番号、メールアドレス、数値項目等）は、エラーダイアログを表示。
- 入力値のバリデーション。

### DB・APIエラー
- DB接続失敗、SQLエラー、API通信失敗時は、ユーザーに「システムエラーが発生しました。管理者に連絡してください。」等のダイアログを表示。

### 予期しない例外
- すべての画面・処理でtry-catchを徹底し、未処理例外はアプリケーションが異常終了しないようにする。

### 操作エラー
- 在庫不足時の受注確定、重複登録、削除不可データの削除等、業務ロジック上のエラーは、ユーザーに理由を明示して通知。

## クラス仕様（詳細）

### ドメインモデル（Entities）
| クラス名                  | 主なプロパティ・役割                                                                 |
|--------------------------|--------------------------------------------------------------------------------------|
| Admin                    | AdminID, Username, PasswordHash, FullName, Email<br>管理者アカウント情報             |
| Product                  | ProductID, ProductName, Price, Stock, CategoryID, AlertThreshold, Description, IsPublished<br>商品情報 |
| ProductCategory          | CategoryID, CategoryName, TaxRate<br>商品カテゴリ情報                                |
| Customer                 | CustomerID, CustomerName, PhoneNumber, Address, RegisteredAt<br>顧客情報             |
| OrderReservation         | ReservationID, ReservationDateTime, CustomerID, TotalAmount, ShippingAddress, PaymentMethod, Status, ImportedDateTime<br>受注ヘッダー |
| OrderReservationItem     | ItemID, ReservationID, ProductID, ProductName, Quantity, UnitPrice, Subtotal<br>受注明細 |
| OrderStatusHistory       | HistoryID, ReservationID, StatusFrom, StatusTo, ChangeDateTime, ChangedByAdminID<br>受注ステータス履歴 |
| AlertLog                 | AlertID, ProductID, DetectedAt, StockAtAlert, IsResolved<br>在庫アラート履歴         |

### リポジトリ（Repositories）
| クラス名                  | 役割・主なメソッド例                                                                 |
|--------------------------|--------------------------------------------------------------------------------------|
| IAdminRepository          | 管理者データ取得・認証（FindByUsername, ValidatePassword など）                      |
| IProductRepository        | 商品データ取得・登録・更新・削除（GetAll, FindById, Add, Update, Delete）            |
| ICustomerRepository       | 顧客データ取得・登録・更新・削除                                                     |
| IOrderReservationRepository | 受注データ取得・登録・更新・削除                                                    |
| IOrderStatusHistoryRepository | ステータス履歴取得・追加                                                         |
| IAlertLogRepository       | アラート履歴取得・追加・更新                                                        |
| 各I〇〇Repositoryの実装（Sql〇〇Repository等） | SQL Serverアクセスの具体実装                                            |

### サービス（Usecases/Services）
| クラス名                  | 役割・主なメソッド例                                                                 |
|--------------------------|--------------------------------------------------------------------------------------|
| LoginUseCase              | ログイン認証処理（Authenticate）                                                    |
| ProductService            | 商品の業務ロジック（在庫アラート判定、商品一括更新等）                              |
| OrderService              | 受注登録、ステータス更新、在庫調整、履歴記録等                                     |
| CustomerService           | 顧客登録・編集、注文履歴取得                                                        |
| CsvImportService          | モックデータ取得・DB登録（将来API連携に差し替え可）                                 |
| AnalyticsService          | 集計・分析処理（売上集計、グラフデータ生成等）                                      |

### ViewModel（Presentation/ViewModels）
| クラス名                  | 役割・主なプロパティ例                                                               |
|--------------------------|--------------------------------------------------------------------------------------|
| LoginViewModel            | ユーザー名、パスワード、ログインコマンド、エラーメッセージ                           |
| ProductListViewModel      | 商品リスト、検索条件、選択商品、コマンド群                                           |
| ProductDetailViewModel    | 商品詳細データ、編集コマンド                                                         |
| OrderListViewModel        | 受注リスト、検索条件、選択受注、コマンド群                                           |
| OrderDetailViewModel      | 受注詳細データ、明細リスト、編集コマンド                                             |
| CustomerListViewModel     | 顧客リスト、検索条件、選択顧客、コマンド群                                           |
| CustomerDetailViewModel   | 顧客詳細データ、注文履歴、編集コマンド                                               |
| AnalyticsViewModel        | 集計データ、グラフデータ、期間選択等                                                 |

### ユーティリティ（Infrastructure/Utils等）
| クラス名                  | 役割                                                                                 |
|--------------------------|--------------------------------------------------------------------------------------|
| PasswordHasher            | パスワードハッシュ化・検証                                                           |
| Logger                    | ログ出力                                                                             |
| ValidationHelper          | 入力値バリデーション                                                                 |
| CsvParser                 | CSVデータのパース（モック用）                                                        |
| ConfigManager             | 設定値取得                                                                           |

### ValueObject（値オブジェクト）

- 本システムでは、ドメインの重要な値のうち、形式保証やバリデーションが必要なもの（例：電話番号、メールアドレス等）についてValueObject（値オブジェクト）を導入する。
- 金額（Money）や商品コード（ProductCode）は、現状の要件（外貨なし・自動連番ID）ではValueObject化の必要はないため導入しない。
- ValueObjectは不変性を持ち、値の妥当性チェック・正規化・等価性比較等のロジックをカプセル化する。
- 画面やDBとのデータ受け渡し時は、ValueObject⇔プリミティブ型の変換処理を実装する。
- 必要に応じて将来的にValueObjectを追加検討する。

#### ValueObject例
| クラス名         | 役割・主なプロパティ           |
|------------------|-------------------------------|
| PhoneNumber      | 電話番号の形式保証・正規化     |
| Email            | メールアドレスの形式保証       |
| OrderDate        | 受注日付の妥当性・フォーマット |
| ReservationId    | 予約IDの形式保証               |

---

## アーキテクチャ設計（詳細）

### 推奨フォルダ構成例

```
SO-OMS/
├─ Application/
│  ├─ Usecases/           # 業務ロジック（サービス/ユースケース）
│  └─ Interfaces/         # リポジトリ等のインターフェース
├─ Domain/
│  ├─ Entities/           # ドメインモデル（Admin, Product, ...）
│  └─ ValueObjects/       # 値オブジェクト（PhoneNumber, Email, Money等）
├─ Infrastructure/
│  ├─ Repositories/       # DBアクセス実装（Sql〇〇Repository等）
│  ├─ Security/           # パスワードハッシュ等
│  └─ Utils/              # ログ・バリデーション等共通処理
├─ Presentation/
│  ├─ Forms/              # WinForms画面（LoginForm, ProductListForm等）
│  └─ ViewModels/         # 各画面用ViewModel
├─ Program.cs             # エントリポイント
├─ App.config             # 設定ファイル
└─ ...（プロジェクトファイル等）
```

### 各層の責任範囲

- **Presentation層**  
  UI（WinForms）、ユーザー入力受付、ViewModelとのデータバインディング、画面遷移・表示制御

- **Application層**  
  業務ロジック（ユースケース）、サービスクラス、リポジトリや外部サービスとの連携、トランザクション管理

- **Domain層**  
  ドメインモデル（エンティティ）、ビジネスルール、**値オブジェクト（ValueObject）**（Entities/ValueObjects配下に配置）

- **Infrastructure層**  
  DBアクセス実装（リポジトリ）、外部サービス連携（API/モック）、共通ユーティリティ（ログ、バリデーション等）、セキュリティ

### その他設計方針

- 依存性逆転の原則に従い、上位層（Application/Domain）は下位層（Infrastructure）に依存しない
- DI（依存性注入）を活用し、テスト容易性・拡張性を確保
- モックデータ取得部分は将来API実装時に差し替え可能な設計

### BootStrapperによる依存性注入

- 依存性注入（DI）はBootStrapperクラスで一元管理し、DIコンテナ（例：Microsoft.Extensions.DependencyInjection）を初期化・依存関係登録を行う。
- BootStrapperはサービス・リポジトリ・ViewModel・フォーム等の依存性を登録し、ServiceProviderを返す静的メソッド（例：BuildServiceProvider）を持つ。
- Program.csのMainメソッドでBootStrapperを呼び出し、ServiceProvider経由で最初のフォーム（例：LoginForm）を生成し、Application.Runで起動する。
- これにより、依存性の集中管理・テスト容易性・将来の拡張性を確保する。

#### BootStrapperクラス例
```csharp
public static class BootStrapper
{
    public static ServiceProvider BuildServiceProvider()
    {
        var services = new ServiceCollection();
        // 依存性の登録
        services.AddSingleton<IProductRepository, SqlProductRepository>();
        services.AddSingleton<IOrderService, OrderService>();
        services.AddSingleton<LoginForm>();
        // ...他のサービス・フォームも登録
        return services.BuildServiceProvider();
    }
}
```

#### Program.csでの利用例
```csharp
static void Main()
{
    Application.EnableVisualStyles();
    Application.SetCompatibleTextRenderingDefault(false);
    var provider = BootStrapper.BuildServiceProvider();
    var loginForm = provider.GetRequiredService<LoginForm>();
    Application.Run(loginForm);
}
```

## 技術仕様

- 開発言語: C#
- フレームワーク: .NET Framework
- データベース: SQL Server 2022
- 外部連携: ECサイトAPI（現状はモックデータ）
- グラフ描画: System.Windows.Forms.DataVisualization.Charting
- 開発環境: Visual Studio 2022
- バージョン管理: Git